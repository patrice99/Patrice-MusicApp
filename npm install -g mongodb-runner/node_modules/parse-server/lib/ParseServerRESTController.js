"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ParseServerRESTController = ParseServerRESTController;
exports.default = void 0;

const Config = require('./Config');

const Auth = require('./Auth');

const RESTController = require('parse/lib/node/RESTController');

const URL = require('url');

const Parse = require('parse/node');

function getSessionToken(options) {
  if (options && typeof options.sessionToken === 'string') {
    return Promise.resolve(options.sessionToken);
  }

  return Promise.resolve(null);
}

function getAuth(options = {}, config) {
  const installationId = options.installationId || 'cloud';

  if (options.useMasterKey) {
    return Promise.resolve(new Auth.Auth({
      config,
      isMaster: true,
      installationId
    }));
  }

  return getSessionToken(options).then(sessionToken => {
    if (sessionToken) {
      options.sessionToken = sessionToken;
      return Auth.getAuthForSessionToken({
        config,
        sessionToken: sessionToken,
        installationId
      });
    } else {
      return Promise.resolve(new Auth.Auth({
        config,
        installationId
      }));
    }
  });
}

function ParseServerRESTController(applicationId, router) {
  function handleRequest(method, path, data = {}, options = {}, config) {
    // Store the arguments, for later use if internal fails
    const args = arguments;

    if (!config) {
      config = Config.get(applicationId);
    }

    const serverURL = URL.parse(config.serverURL);

    if (path.indexOf(serverURL.path) === 0) {
      path = path.slice(serverURL.path.length, path.length);
    }

    if (path[0] !== '/') {
      path = '/' + path;
    }

    if (path === '/batch') {
      let initialPromise = Promise.resolve();

      if (data.transaction === true) {
        initialPromise = config.database.createTransactionalSession();
      }

      return initialPromise.then(() => {
        const promises = data.requests.map(request => {
          return handleRequest(request.method, request.path, request.body, options, config).then(response => {
            return {
              success: response
            };
          }, error => {
            return {
              error: {
                code: error.code,
                error: error.message
              }
            };
          });
        });
        return Promise.all(promises).then(result => {
          if (data.transaction === true) {
            if (result.find(resultItem => typeof resultItem.error === 'object')) {
              return config.database.abortTransactionalSession().then(() => {
                return Promise.reject(result);
              });
            } else {
              return config.database.commitTransactionalSession().then(() => {
                return result;
              });
            }
          } else {
            return result;
          }
        });
      });
    }

    let query;

    if (method === 'GET') {
      query = data;
    }

    return new Promise((resolve, reject) => {
      getAuth(options, config).then(auth => {
        const request = {
          body: data,
          config,
          auth,
          info: {
            applicationId: applicationId,
            sessionToken: options.sessionToken
          },
          query
        };
        return Promise.resolve().then(() => {
          return router.tryRouteRequest(method, path, request);
        }).then(response => {
          resolve(response.response, response.status, response);
        }, err => {
          if (err instanceof Parse.Error && err.code == Parse.Error.INVALID_JSON && err.message == `cannot route ${method} ${path}`) {
            RESTController.request.apply(null, args).then(resolve, reject);
          } else {
            reject(err);
          }
        });
      }, reject);
    });
  }

  return {
    request: handleRequest,
    ajax: RESTController.ajax
  };
}

var _default = ParseServerRESTController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9QYXJzZVNlcnZlclJFU1RDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNvbmZpZyIsInJlcXVpcmUiLCJBdXRoIiwiUkVTVENvbnRyb2xsZXIiLCJVUkwiLCJQYXJzZSIsImdldFNlc3Npb25Ub2tlbiIsIm9wdGlvbnMiLCJzZXNzaW9uVG9rZW4iLCJQcm9taXNlIiwicmVzb2x2ZSIsImdldEF1dGgiLCJjb25maWciLCJpbnN0YWxsYXRpb25JZCIsInVzZU1hc3RlcktleSIsImlzTWFzdGVyIiwidGhlbiIsImdldEF1dGhGb3JTZXNzaW9uVG9rZW4iLCJQYXJzZVNlcnZlclJFU1RDb250cm9sbGVyIiwiYXBwbGljYXRpb25JZCIsInJvdXRlciIsImhhbmRsZVJlcXVlc3QiLCJtZXRob2QiLCJwYXRoIiwiZGF0YSIsImFyZ3MiLCJhcmd1bWVudHMiLCJnZXQiLCJzZXJ2ZXJVUkwiLCJwYXJzZSIsImluZGV4T2YiLCJzbGljZSIsImxlbmd0aCIsImluaXRpYWxQcm9taXNlIiwidHJhbnNhY3Rpb24iLCJkYXRhYmFzZSIsImNyZWF0ZVRyYW5zYWN0aW9uYWxTZXNzaW9uIiwicHJvbWlzZXMiLCJyZXF1ZXN0cyIsIm1hcCIsInJlcXVlc3QiLCJib2R5IiwicmVzcG9uc2UiLCJzdWNjZXNzIiwiZXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsImFsbCIsInJlc3VsdCIsImZpbmQiLCJyZXN1bHRJdGVtIiwiYWJvcnRUcmFuc2FjdGlvbmFsU2Vzc2lvbiIsInJlamVjdCIsImNvbW1pdFRyYW5zYWN0aW9uYWxTZXNzaW9uIiwicXVlcnkiLCJhdXRoIiwiaW5mbyIsInRyeVJvdXRlUmVxdWVzdCIsInN0YXR1cyIsImVyciIsIkVycm9yIiwiSU5WQUxJRF9KU09OIiwiYXBwbHkiLCJhamF4Il0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLE1BQU1BLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBdEI7O0FBQ0EsTUFBTUMsSUFBSSxHQUFHRCxPQUFPLENB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S0FBSyxDQUFDdUQsS0FBckIsSUFDQUQsR0FBRyxDQUFDZCxJQUFKLElBQVl4QyxLQUFLLENBQUN1RCxLQUFOLENBQVlDLFlBRHhCLElBRUFGLEdBQUcsQ0FBQ2IsT0FBSixJQUFnQixnQkFBZXhCLE1BQU8sSUFBR0MsSUFBSyxFQUhoRCxFQUlFO0FBQ0FwQixZQUFBQSxjQUFjLENBQUNxQyxPQUFmLENBQXVCc0IsS0FBdkIsQ0FBNkIsSUFBN0IsRUFBbUNyQyxJQUFuQyxFQUF5Q1QsSUFBekMsQ0FBOENOLE9BQTlDLEVBQXVEMEMsTUFBdkQ7QUFDRCxXQU5ELE1BTU87QUFDTEEsWUFBQUEsTUFBTSxDQUFDTyxHQUFELENBQU47QUFDRDtBQUNGLFNBbEJFLENBQVA7QUFvQkQsT0EvQkQsRUErQkdQLE1BL0JIO0FBZ0NELEtBakNNLENBQVA7QUFrQ0Q7O0FBRUQsU0FBTztBQUNMWixJQUFBQSxPQUFPLEVBQUVuQixhQURKO0FBRUwwQyxJQUFBQSxJQUFJLEVBQUU1RCxjQUFjLENBQUM0RDtBQUZoQixHQUFQO0FBSUQ7O2VBRWM3Qyx5QiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IENvbmZpZyA9IHJlcXVpcmUoJy4vQ29uZmlnJyk7XG5jb25zdCBBdXRoID0gcmVxdWlyZSgnLi9BdXRoJyk7XG5jb25zdCBSRVNUQ29udHJvbGxlciA9IHJlcXVpcmUoJ3BhcnNlL2xpYi9ub2RlL1JFU1RDb250cm9sbGVyJyk7XG5jb25zdCBVUkwgPSByZXF1aXJlKCd1cmwnKTtcbmNvbnN0IFBhcnNlID0gcmVxdWlyZSgncGFyc2Uvbm9kZScpO1xuXG5mdW5jdGlvbiBnZXRTZXNzaW9uVG9rZW4ob3B0aW9ucykge1xuICBpZiAob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5zZXNzaW9uVG9rZW4gPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShvcHRpb25zLnNlc3Npb25Ub2tlbik7XG4gIH1cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbn1cblxuZnVuY3Rpb24gZ2V0QXV0aChvcHRpb25zID0ge30sIGNvbmZpZykge1xuICBjb25zdCBpbnN0YWxsYXRpb25JZCA9IG9wdGlvbnMuaW5zdGFsbGF0aW9uSWQgfHwgJ2Nsb3VkJztcbiAgaWYgKG9wdGlvbnMudXNlTWFzdGVyS2V5KSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShcbiAgICAgIG5ldyBBdXRoLkF1dGgoeyBjb25maWcsIGlzTWFzdGVyOiB0cnVlLCBpbnN0YWxsYXRpb25JZCB9KVxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGdldFNlc3Npb25Ub2tlbihvcHRpb25zKS50aGVuKHNlc3Npb25Ub2tlbiA9PiB7XG4gICAgaWYgKHNlc3Npb25Ub2tlbikge1xuICAgICAgb3B0aW9ucy5zZXNzaW9uVG9rZW4gPSBzZXNzaW9uVG9rZW47XG4gICAgICByZXR1cm4gQXV0aC5nZXRBdXRoRm9yU2Vzc2lvblRva2VuKHtcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBzZXNzaW9uVG9rZW46IHNlc3Npb25Ub2tlbixcbiAgICAgICAgaW5zdGFsbGF0aW9uSWQsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQXV0aC5BdXRoKHsgY29uZmlnLCBpbnN0YWxsYXRpb25JZCB9KSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlcihhcHBsaWNhdGlvbklkLCByb3V0ZXIpIHtcbiAgZnVuY3Rpb24gaGFuZGxlUmVxdWVzdChtZXRob2QsIHBhdGgsIGRhdGEgPSB7fSwgb3B0aW9ucyA9IHt9LCBjb25maWcpIHtcbiAgICAvLyBTdG9yZSB0aGUgYXJndW1lbnRzLCBmb3IgbGF0ZXIgdXNlIGlmIGludGVybmFsIGZhaWxzXG4gICAgY29uc3QgYXJncyA9IGFyZ3VtZW50cztcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICBjb25maWcgPSBDb25maWcuZ2V0KGFwcGxpY2F0aW9uSWQpO1xuICAgIH1cbiAgICBjb25zdCBzZXJ2ZXJVUkwgPSBVUkwucGFyc2UoY29uZmlnLnNlcnZlclVSTCk7XG4gICAgaWYgKHBhdGguaW5kZXhPZihzZXJ2ZXJVUkwucGF0aCkgPT09IDApIHtcbiAgICAgIHBhdGggPSBwYXRoLnNsaWNlKHNlcnZlclVSTC5wYXRoLmxlbmd0aCwgcGF0aC5sZW5ndGgpO1xuICAgIH1cblxuICAgIGlmIChwYXRoWzBdICE9PSAnLycpIHtcbiAgICAgIHBhdGggPSAnLycgKyBwYXRoO1xuICAgIH1cblxuICAgIGlmIChwYXRoID09PSAnL2JhdGNoJykge1xuICAgICAgbGV0IGluaXRpYWxQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICBpZiAoZGF0YS50cmFuc2FjdGlvbiA9PT0gdHJ1ZSkge1xuICAgICAgICBpbml0aWFsUHJvbWlzZSA9IGNvbmZpZy5kYXRhYmFzZS5jcmVhdGVUcmFuc2FjdGlvbmFsU2Vzc2lvbigpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGluaXRpYWxQcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgICBjb25zdCBwcm9taXNlcyA9IGRhdGEucmVxdWVzdHMubWFwKHJlcXVlc3QgPT4ge1xuICAgICAgICAgIHJldHVybiBoYW5kbGVSZXF1ZXN0KFxuICAgICAgICAgICAgcmVxdWVzdC5tZXRob2QsXG4gICAgICAgICAgICByZXF1ZXN0LnBhdGgsXG4gICAgICAgICAgICByZXF1ZXN0LmJvZHksXG4gICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgY29uZmlnXG4gICAgICAgICAgKS50aGVuKFxuICAgICAgICAgICAgcmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiByZXNwb25zZSB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBlcnJvcjogeyBjb2RlOiBlcnJvci5jb2RlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9LFxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICBpZiAoZGF0YS50cmFuc2FjdGlvbiA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICByZXN1bHQuZmluZChyZXN1bHRJdGVtID0+IHR5cGVvZiByZXN1bHRJdGVtLmVycm9yID09PSAnb2JqZWN0JylcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICByZXR1cm4gY29uZmlnLmRhdGFiYXNlLmFib3J0VHJhbnNhY3Rpb25hbFNlc3Npb24oKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QocmVzdWx0KTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gY29uZmlnLmRhdGFiYXNlLmNvbW1pdFRyYW5zYWN0aW9uYWxTZXNzaW9uKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGxldCBxdWVyeTtcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcXVlcnkgPSBkYXRhO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBnZXRBdXRoKG9wdGlvbnMsIGNvbmZpZykudGhlbihhdXRoID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgICBib2R5OiBkYXRhLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBhdXRoLFxuICAgICAgICAgIGluZm86IHtcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uSWQ6IGFwcGxpY2F0aW9uSWQsXG4gICAgICAgICAgICBzZXNzaW9uVG9rZW46IG9wdGlvbnMuc2Vzc2lvblRva2VuLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcXVlcnksXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiByb3V0ZXIudHJ5Um91dGVSZXF1ZXN0KG1ldGhvZCwgcGF0aCwgcmVxdWVzdCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZS5yZXNwb25zZSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGVyciBpbnN0YW5jZW9mIFBhcnNlLkVycm9yICYmXG4gICAgICAgICAgICAgICAgZXJyLmNvZGUgPT0gUGFyc2UuRXJyb3IuSU5WQUxJRF9KU09OICYmXG4gICAgICAgICAgICAgICAgZXJyLm1lc3NhZ2UgPT0gYGNhbm5vdCByb3V0ZSAke21ldGhvZH0gJHtwYXRofWBcbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgUkVTVENvbnRyb2xsZXIucmVxdWVzdC5hcHBseShudWxsLCBhcmdzKS50aGVuKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuICAgICAgfSwgcmVqZWN0KTtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcmVxdWVzdDogaGFuZGxlUmVxdWVzdCxcbiAgICBhamF4OiBSRVNUQ29udHJvbGxlci5hamF4LFxuICB9O1xufVxuXG5leHBvcnQgZGVmYXVsdCBQYXJzZVNlcnZlclJFU1RDb250cm9sbGVyO1xuZXhwb3J0IHsgUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlciB9O1xuIl19