"use strict";

const ldapjs = require('ldapjs');

const Parse = require('parse/node').Parse;

function validateAuthData(authData, options) {
  if (!optionsAreValid(options)) {
    return new Promise((_, reject) => {
      reject(new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'LDAP auth configuration missing'));
    });
  }

  const client = ldapjs.createClient({
    url: options.url
  });
  const userCn = typeof options.dn === 'string' ? options.dn.replace('{{id}}', authData.id) : `uid=${authData.id},${options.suffix}`;
  return new Promise((resolve, reject) => {
    client.bind(userCn, authData.password, err => {
      if (err) {
        client.destroy(err);
        return reject(new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'LDAP: Wrong username or password'));
      }

      if (typeof options.groupCn === 'string' && typeof options.groupFilter === 'string') {
        searchForGroup(client, options, authData.id, resolve, reject);
      } else {
        client.unbind();
        client.destroy();
        resolve();
      }
    });
  });
}

function optionsAreValid(options) {
  return typeof options === 'object' && typeof options.suffix === 'string' && typeof options.url === 'string' && options.url.startsWith('ldap://');
}

function searchForGroup(client, options, id, resolve, reject) {
  const filter = options.groupFilter.replace(/{{id}}/gi, id);
  const opts = {
    scope: 'sub',
    filter: filter
  };
  let found = false;
  client.search(options.suffix, opts, (searchError, res) => {
    if (searchError) {
      client.unbind();
      client.destroy();
      return reject(new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'LDAP group search failed'));
    }

    res.on('searchEntry', entry => {
      if (entry.object.cn === options.groupCn) {
        found = true;
        client.unbind();
        client.destroy();
        return resolve();
      }
    });
    res.on('end', () => {
      if (!found) {
        client.unbind();
        client.destroy();
        return reject(new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'LDAP: User not in group'));
      }
    });
    res.on('error', () => {
      return reject(new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'LDAP group search failed'));
    });
  });
}

function validateAppId() {
  return Promise.resolve();
}

module.exports = {
  validateAppId,
  validateAuthData
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9BdXRoL2xkYXAuanMiXSwibmFtZXMiOlsibGRhcGpzIiwicmVxdWlyZSIsIlBhcnNlIiwidmFsaWRhdGVBdXRoRGF0YSIsImF1dGhEYXRhIiwib3B0aW9ucyIsIm9wdGlvbnNBcmVWYWxpZCIsIlByb21pc2UiLCJfIiwicmVqZWN0IiwiRXJyb3IiLCJJTlRFUk5BTF9TRVJWRVJfRVJST1IiLCJjbGllbnQiLCJjcmVhdGVDbGllbnQiLCJ1cmwiLCJ1c2VyQ24iLCJkbiIsInJlcGxhY2UiLCJpZCIsInN1ZmZpeCIsInJlc29sdmUiLCJiaW5kIiwicGFzc3dvcmQiLCJlcnIiLCJkZXN0cm95IiwiT0JKRUNUX05PVF9GT1VORCIsImdyb3VwQ24iLCJncm91cEZpbHRlciIsInNlYXJjaEZvckdyb3VwIiwidW5iaW5kIiwic3RhcnRzV2l0aCIsImZpbHRlciIsIm9wdHMiLCJzY29wZSIsImZvdW5kIiwic2VhcmNoIiwic2VhcmNoRXJyb3IiLCJyZXMiLCJvbiIsImVudHJ5Iiwib2JqZWN0IiwiY24iLCJ2YWxpZGF0ZUFwcElkIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1DLEtBQUssR0FBR0QsT0FBTyxDQUFDLFlBQUQsQ0FBUCxDQUFzQkMsS0FBcEM7O0FBRUEsU0FBU0MsZ0JBQVQsQ0FBMEJDLFFBQTFCLEVBQW9DQyxPQUFwQyxFQUE2QztBQUMzQyxNQUFJLENBQUNDLGVBQWUsQ0FBQ0QsT0FBRCxDQUFwQixFQUErQjtBQUM3QixXQUFPLElBQUlFLE9BQUosQ0FBWSxDQUFDQyxDQUFELEVBQUlDLE1BQUosS0FBZTtBQUNoQ0EsTUFBQUEsTUFBTSxDQUNKLElBQUlQLEtBQUssQ0FBQ1EsS0FBVixDQUNFUixLQUFLLENBQUNRLEtBQU4sQ0FBWUMscUJBRGQsRUFFRSxpQ0FGRixDQURJLENBQU47QUFNRCxLQVBN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RUFBeUM7QUFDdkNRLFFBQUFBLEtBQUssR0FBRyxJQUFSO0FBQ0F0QixRQUFBQSxNQUFNLENBQUNpQixNQUFQO0FBQ0FqQixRQUFBQSxNQUFNLENBQUNZLE9BQVA7QUFDQSxlQUFPSixPQUFPLEVBQWQ7QUFDRDtBQUNGLEtBUEQ7QUFRQWlCLElBQUFBLEdBQUcsQ0FBQ0MsRUFBSixDQUFPLEtBQVAsRUFBYyxNQUFNO0FBQ2xCLFVBQUksQ0FBQ0osS0FBTCxFQUFZO0FBQ1Z0QixRQUFBQSxNQUFNLENBQUNpQixNQUFQO0FBQ0FqQixRQUFBQSxNQUFNLENBQUNZLE9BQVA7QUFDQSxlQUFPZixNQUFNLENBQ1gsSUFBSVAsS0FBSyxDQUFDUSxLQUFWLENBQ0VSLEtBQUssQ0FBQ1EsS0FBTixDQUFZQyxxQkFEZCxFQUVFLHlCQUZGLENBRFcsQ0FBYjtBQU1EO0FBQ0YsS0FYRDtBQVlBMEIsSUFBQUEsR0FBRyxDQUFDQyxFQUFKLENBQU8sT0FBUCxFQUFnQixNQUFNO0FBQ3BCLGFBQU83QixNQUFNLENBQ1gsSUFBSVAsS0FBSyxDQUFDUSxLQUFWLENBQ0VSLEtBQUssQ0FBQ1EsS0FBTixDQUFZQyxxQkFEZCxFQUVFLDBCQUZGLENBRFcsQ0FBYjtBQU1ELEtBUEQ7QUFRRCxHQXZDRDtBQXdDRDs7QUFFRCxTQUFTK0IsYUFBVCxHQUF5QjtBQUN2QixTQUFPbkMsT0FBTyxDQUFDYSxPQUFSLEVBQVA7QUFDRDs7QUFFRHVCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUNmRixFQUFBQSxhQURlO0FBRWZ2QyxFQUFBQTtBQUZlLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgbGRhcGpzID0gcmVxdWlyZSgnbGRhcGpzJyk7XG5jb25zdCBQYXJzZSA9IHJlcXVpcmUoJ3BhcnNlL25vZGUnKS5QYXJzZTtcblxuZnVuY3Rpb24gdmFsaWRhdGVBdXRoRGF0YShhdXRoRGF0YSwgb3B0aW9ucykge1xuICBpZiAoIW9wdGlvbnNBcmVWYWxpZChvcHRpb25zKSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgoXywgcmVqZWN0KSA9PiB7XG4gICAgICByZWplY3QoXG4gICAgICAgIG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICBQYXJzZS5FcnJvci5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICAgICAgJ0xEQVAgYXV0aCBjb25maWd1cmF0aW9uIG1pc3NpbmcnXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBjb25zdCBjbGllbnQgPSBsZGFwanMuY3JlYXRlQ2xpZW50KHsgdXJsOiBvcHRpb25zLnVybCB9KTtcbiAgY29uc3QgdXNlckNuID1cbiAgICB0eXBlb2Ygb3B0aW9ucy5kbiA9PT0gJ3N0cmluZydcbiAgICAgID8gb3B0aW9ucy5kbi5yZXBsYWNlKCd7e2lkfX0nLCBhdXRoRGF0YS5pZClcbiAgICAgIDogYHVpZD0ke2F1dGhEYXRhLmlkfSwke29wdGlvbnMuc3VmZml4fWA7XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjbGllbnQuYmluZCh1c2VyQ24sIGF1dGhEYXRhLnBhc3N3b3JkLCBlcnIgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjbGllbnQuZGVzdHJveShlcnIpO1xuICAgICAgICByZXR1cm4gcmVqZWN0KFxuICAgICAgICAgIG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICAgIFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsXG4gICAgICAgICAgICAnTERBUDogV3JvbmcgdXNlcm5hbWUgb3IgcGFzc3dvcmQnXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAoXG4gICAgICAgIHR5cGVvZiBvcHRpb25zLmdyb3VwQ24gPT09ICdzdHJpbmcnICYmXG4gICAgICAgIHR5cGVvZiBvcHRpb25zLmdyb3VwRmlsdGVyID09PSAnc3RyaW5nJ1xuICAgICAgKSB7XG4gICAgICAgIHNlYXJjaEZvckdyb3VwKGNsaWVudCwgb3B0aW9ucywgYXV0aERhdGEuaWQsIHJlc29sdmUsIHJlamVjdCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjbGllbnQudW5iaW5kKCk7XG4gICAgICAgIGNsaWVudC5kZXN0cm95KCk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIG9wdGlvbnNBcmVWYWxpZChvcHRpb25zKSB7XG4gIHJldHVybiAoXG4gICAgdHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmXG4gICAgdHlwZW9mIG9wdGlvbnMuc3VmZml4ID09PSAnc3RyaW5nJyAmJlxuICAgIHR5cGVvZiBvcHRpb25zLnVybCA9PT0gJ3N0cmluZycgJiZcbiAgICBvcHRpb25zLnVybC5zdGFydHNXaXRoKCdsZGFwOi8vJylcbiAgKTtcbn1cblxuZnVuY3Rpb24gc2VhcmNoRm9yR3JvdXAoY2xpZW50LCBvcHRpb25zLCBpZCwgcmVzb2x2ZSwgcmVqZWN0KSB7XG4gIGNvbnN0IGZpbHRlciA9IG9wdGlvbnMuZ3JvdXBGaWx0ZXIucmVwbGFjZSgve3tpZH19L2dpLCBpZCk7XG4gIGNvbnN0IG9wdHMgPSB7XG4gICAgc2NvcGU6ICdzdWInLFxuICAgIGZpbHRlcjogZmlsdGVyLFxuICB9O1xuICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgY2xpZW50LnNlYXJjaChvcHRpb25zLnN1ZmZpeCwgb3B0cywgKHNlYXJjaEVycm9yLCByZXMpID0+IHtcbiAgICBpZiAoc2VhcmNoRXJyb3IpIHtcbiAgICAgIGNsaWVudC51bmJpbmQoKTtcbiAgICAgIGNsaWVudC5kZXN0cm95KCk7XG4gICAgICByZXR1cm4gcmVqZWN0KFxuICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgUGFyc2UuRXJyb3IuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgICAgICdMREFQIGdyb3VwIHNlYXJjaCBmYWlsZWQnXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfVxuICAgIHJlcy5vbignc2VhcmNoRW50cnknLCBlbnRyeSA9PiB7XG4gICAgICBpZiAoZW50cnkub2JqZWN0LmNuID09PSBvcHRpb25zLmdyb3VwQ24pIHtcbiAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICBjbGllbnQudW5iaW5kKCk7XG4gICAgICAgIGNsaWVudC5kZXN0cm95KCk7XG4gICAgICAgIHJldHVybiByZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmVzLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICBpZiAoIWZvdW5kKSB7XG4gICAgICAgIGNsaWVudC51bmJpbmQoKTtcbiAgICAgICAgY2xpZW50LmRlc3Ryb3koKTtcbiAgICAgICAgcmV0dXJuIHJlamVjdChcbiAgICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgICBQYXJzZS5FcnJvci5JTlRFUk5BTF9TRVJWRVJfRVJST1IsXG4gICAgICAgICAgICAnTERBUDogVXNlciBub3QgaW4gZ3JvdXAnXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJlcy5vbignZXJyb3InLCAoKSA9PiB7XG4gICAgICByZXR1cm4gcmVqZWN0KFxuICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgUGFyc2UuRXJyb3IuSU5URVJOQUxfU0VSVkVSX0VSUk9SLFxuICAgICAgICAgICdMREFQIGdyb3VwIHNlYXJjaCBmYWlsZWQnXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUFwcElkKCkge1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICB2YWxpZGF0ZUFwcElkLFxuICB2YWxpZGF0ZUF1dGhEYXRhLFxufTtcbiJdfQ==